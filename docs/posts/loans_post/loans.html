<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Andre Xiao">
<meta name="dcterms.date" content="2024-03-03">
<meta name="description" content="Optimizing and assessing the impact of an automated decision system for bank loans.">

<title>CSCI 0451 Machine Learning - Bank Loans</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: white;
      }

      .quarto-title-block .quarto-title-banner {
        color: white;
background-image: url(../../img/landscape.png);
background-size: cover;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">CSCI 0451 Machine Learning</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Bank Loans</h1>
                  <div>
        <div class="description">
          Optimizing and assessing the impact of an automated decision system for bank loans.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Andre Xiao </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 3, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://www.techfunnel.com/wp-content/uploads/2021/07/benefits_of_business_loans.png" class="img-fluid figure-img"></p>
<figcaption>Image source: techfunnel.com</figcaption>
</figure>
</div>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This study attempts to optimize the maximum total expected profit from loans for an unknown bank. I will be trying to create an automated decision-making sytem that gives each prospective borrower a score and decides whether to give them a loan based on a threshold, <span class="math inline">\(t\)</span>, where each score, <span class="math inline">\(s_i\)</span>, of borrower, <span class="math inline">\(i\)</span>, is defined as <span id="eq-score"><span class="math display">\[s_i = \langle \mathbf{X}_i, \mathbf{w} \rangle \tag{1}\]</span></span> where <span class="math inline">\(\mathbf{X}_i\)</span> is the vector of features for borrower, <span class="math inline">\(i\)</span>, and <span class="math inline">\(\mathbf{w}\)</span> is the vector of weights for each feature. Using this, the goal is to find <span class="math inline">\(\mathbf{w}\)</span> and <span class="math inline">\(t\)</span> which maximize the total expected profit per loan for the bank.</p>
<p>To accomplish this, I use logistic regression to determine <span class="math inline">\(\mathbf{w}\)</span> and calculate the expected profit per loan for various <span class="math inline">\(t\)</span>-values. In this study, we assume that each loan is a 10-year loan and 75% of the interest is used to pay for operating costs such as employee salaries. We also assume that defaults occur after three years and the bank loses 70% of the principal. That is, <span id="eq-profit-cost"><span class="math display">\[\begin{align*}
    \textbf{profit} &amp;= \text{loan amount}\cdot(1+0.25\cdot\text{interest rate})^{10} - \text{loan amount} \\
    \textbf{cost} &amp;= \text{loan amount}\cdot(1+0.25\cdot\text{interest rate})^3 - 1.7\cdot\text{loan amount}
\end{align*} \tag{2}\]</span></span></p>
<p>In the end, the expected profit per loan for the bank was $1714.51.</p>
<p>Afterwards, I discuss the impact that the automated system has on different segments of the population of prospective borrowers. I explore how the system impacts different age groups, purposes for the loan request, and income levels. I find that it is easier for younger age groups to receive loans, harder to take out student loans and loans for ventures, and it is much easier for higher income-levels to receive loans under my system.</p>
</section>
<section id="preparing-the-training-data" class="level2">
<h2 class="anchored" data-anchor-id="preparing-the-training-data">Preparing the Training Data</h2>
<div id="cell-2" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(<span class="st">"ignore"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/PhilChodrow/ml-notes/main/data/credit-risk/train.csv"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> pd.read_csv(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The dataset contains the following columns:</p>
<ul>
<li><code>person_age</code>: the age of the prospective borrower.</li>
<li><code>person_income</code>: the income of the prospective borrower at the time of application.</li>
<li><code>person_home_ownership</code>: the home ownership status of the prospective borrower at the time of application. Possible values are <code>MORTGAGE</code>, <code>OWN</code>, <code>RENT</code>, and <code>OTHER</code>.</li>
<li><code>person_emp_length</code>: the length of the most recent employment for the prospective borrower, in years.</li>
<li><code>loan_intent</code>: the purpose of the loan request.</li>
<li><code>loan_grade</code>: a composite measure of the likelihood of the borrower to repay the loan. <strong>My system will give its own score to each borrower.</strong></li>
<li><code>loan_amnt</code>: the amount of the loan.</li>
<li><code>loan_int_rate</code>, the annual interest rate on the loan in percent. <strong>This is the target variable.</strong></li>
<li><code>loan_status</code>: whether (<code>1</code>) or not (<code>0</code>) the borrower defaulted on the loan.</li>
<li><code>loan_percent_income</code>: the amount of the loan as a proportion of the prospective borrower’s personal income. This is caluculated as <code>loan_amnt</code>/<code>person_income</code>.</li>
<li><code>cb_person_default_on_file</code>: whether the prospective borrower has previously defaulted on a loan in the records of a credit bureau.</li>
<li><code>cb_person_cred_hist_length</code>: the length of credit history of the prospective borrower, in years.</li>
</ul>
<p>In addition to the columns given by the data set, I will add another column:</p>
<ul>
<li><code>int_percent_income</code>: the amount of yearly interest as a proportion of the borrower’s income. Calculated as <code>int_percent_income = loan_percent_income * loan_int_rate</code>.</li>
</ul>
<p>I will also be changing <code>loan_int_rate</code> from a percentage to a fraction before calculating <code>int_percent_income</code>.</p>
<div id="cell-4" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="annotated-cell-2"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="1">1</button><span id="annotated-cell-2-1" class="code-annotation-target"><a href="#annotated-cell-2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_data(df):</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="2">2</button><span id="annotated-cell-2-2" class="code-annotation-target"><a href="#annotated-cell-2-2" aria-hidden="true" tabindex="-1"></a>    df_ <span class="op">=</span> df.copy()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="3">3</button><span id="annotated-cell-2-3" class="code-annotation-target"><a href="#annotated-cell-2-3" aria-hidden="true" tabindex="-1"></a>    df_ <span class="op">=</span> df_.dropna()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="4">4</button><span id="annotated-cell-2-4" class="code-annotation-target"><a href="#annotated-cell-2-4" aria-hidden="true" tabindex="-1"></a>    df_[<span class="st">'loan_int_rate'</span>] <span class="op">=</span> df_[<span class="st">'loan_int_rate'</span>] <span class="op">/</span> <span class="dv">100</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="5">5</button><span id="annotated-cell-2-5" class="code-annotation-target"><a href="#annotated-cell-2-5" aria-hidden="true" tabindex="-1"></a>    df_[<span class="st">'int_percent_income'</span>] <span class="op">=</span> df_[<span class="st">'loan_percent_income'</span>] <span class="op">*</span> df_[<span class="st">'loan_int_rate'</span>]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="6">6</button><span id="annotated-cell-2-6" class="code-annotation-target"><a href="#annotated-cell-2-6" aria-hidden="true" tabindex="-1"></a>    df_ <span class="op">=</span> df_[(df_[<span class="st">'person_age'</span>] <span class="op">&lt;=</span> <span class="dv">100</span>) <span class="op">&amp;</span> (df_[<span class="st">'person_emp_length'</span>] <span class="op">&lt;=</span> <span class="dv">100</span>)]</span>
<span id="annotated-cell-2-7"><a href="#annotated-cell-2-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_</span>
<span id="annotated-cell-2-8"><a href="#annotated-cell-2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-2-9"><a href="#annotated-cell-2-9" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> prepare_data(df_train)</span>
<span id="annotated-cell-2-10"><a href="#annotated-cell-2-10" aria-hidden="true" tabindex="-1"></a>df_train.head()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="1" data-code-annotation="1">Function to prepare data.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="2" data-code-annotation="2">Copy dataframe</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="3" data-code-annotation="3">Drop all NaNs</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="4" data-code-annotation="4">Converts <code>loan_int_rate</code> to fraction from percent.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="5" data-code-annotation="5">Calculates <code>int_percent_income</code> and add it as a new column.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="6" data-code-annotation="6">Drops all people over the age of 100 and have employment lengths over 100 years.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">person_age</th>
<th data-quarto-table-cell-role="th">person_income</th>
<th data-quarto-table-cell-role="th">person_home_ownership</th>
<th data-quarto-table-cell-role="th">person_emp_length</th>
<th data-quarto-table-cell-role="th">loan_intent</th>
<th data-quarto-table-cell-role="th">loan_grade</th>
<th data-quarto-table-cell-role="th">loan_amnt</th>
<th data-quarto-table-cell-role="th">loan_int_rate</th>
<th data-quarto-table-cell-role="th">loan_status</th>
<th data-quarto-table-cell-role="th">loan_percent_income</th>
<th data-quarto-table-cell-role="th">cb_person_default_on_file</th>
<th data-quarto-table-cell-role="th">cb_person_cred_hist_length</th>
<th data-quarto-table-cell-role="th">int_percent_income</th>
<th data-quarto-table-cell-role="th">age_group</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>27</td>
<td>98000</td>
<td>RENT</td>
<td>3.0</td>
<td>EDUCATION</td>
<td>C</td>
<td>11750</td>
<td>1.347000e-19</td>
<td>0</td>
<td>0.12</td>
<td>Y</td>
<td>6</td>
<td>1.616400e-20</td>
<td>20-29</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>22</td>
<td>36996</td>
<td>RENT</td>
<td>5.0</td>
<td>EDUCATION</td>
<td>A</td>
<td>10000</td>
<td>7.510000e-20</td>
<td>0</td>
<td>0.27</td>
<td>N</td>
<td>4</td>
<td>2.027700e-20</td>
<td>20-29</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>24</td>
<td>26000</td>
<td>RENT</td>
<td>2.0</td>
<td>MEDICAL</td>
<td>C</td>
<td>1325</td>
<td>1.287000e-19</td>
<td>1</td>
<td>0.05</td>
<td>N</td>
<td>4</td>
<td>6.435000e-21</td>
<td>20-29</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>29</td>
<td>53004</td>
<td>MORTGAGE</td>
<td>2.0</td>
<td>HOMEIMPROVEMENT</td>
<td>A</td>
<td>15000</td>
<td>9.630000e-20</td>
<td>0</td>
<td>0.28</td>
<td>N</td>
<td>10</td>
<td>2.696400e-20</td>
<td>20-29</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>21</td>
<td>21700</td>
<td>RENT</td>
<td>2.0</td>
<td>HOMEIMPROVEMENT</td>
<td>D</td>
<td>5500</td>
<td>1.491000e-19</td>
<td>1</td>
<td>0.25</td>
<td>N</td>
<td>2</td>
<td>3.727500e-20</td>
<td>20-29</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="exploring-the-data" class="level2">
<h2 class="anchored" data-anchor-id="exploring-the-data">Exploring the Data</h2>
<p>Let’s first take a look at how the loan interest rate and the yearly interest amount as a proportion of income (loan percent of income) relates to whether or not a borrower will default. The reason this may be a good place to start is because it is intuitive to think that a higher interest rate could result in more defaults. Additionally, it is also intuitive to think that the larger the loan amount is compared to a person’s income, the chance of defaulting increases. So, we can put these ideas together and conclude that interest rates and the loan percent of income of income could be closely related to the chance of defaulting.</p>
<div id="cell-fig-int-percent-income" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>pltt <span class="op">=</span> <span class="st">'Paired'</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>int_income_plt <span class="op">=</span> sns.scatterplot(df_train,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                                 x <span class="op">=</span> <span class="st">'loan_percent_income'</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                                 y <span class="op">=</span> <span class="st">'loan_int_rate'</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                                 hue <span class="op">=</span> <span class="st">'loan_status'</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                                 palette <span class="op">=</span> pltt)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>int_income_plt.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="st">'Loan Percent of Income'</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                   ylabel <span class="op">=</span> <span class="st">'Loan Interest Rate'</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                   title <span class="op">=</span> <span class="st">'Interest Cost vs. Income'</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>int_income_plt.legend(title <span class="op">=</span> <span class="st">'Default'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-int-percent-income" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-int-percent-income-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="loans_files/figure-html/fig-int-percent-income-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-int-percent-income-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Defaults by interest percent of income.
</figcaption>
</figure>
</div>
</div>
</div>
<p>As we can see, most defaults occur along the outer ring (dark blue dots). This confirms our intuition. As interest rate increases, more defaults occur and the same can be seen with the loan percent of income. Additionally, this figure (<a href="#fig-int-percent-income" class="quarto-xref">Figure&nbsp;1</a>) provides a good visualization of the interest percent of income (<code>int_percent_income</code>). With that said, <code>loan_int_rate</code>, <code>loan_percent_income</code>, and <code>int_percent_income</code> seem like good features to use.</p>
<p>Next, let’s try to find some features that agree with this pattern. First, let’s take a look at <code>loan_intent</code>.</p>
<div class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="annotated-cell-4"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1">1</button><span id="annotated-cell-4-1" class="code-annotation-target"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a>df_train.groupby([<span class="st">"loan_intent"</span>]).agg({<span class="st">'loan_status'</span>:<span class="st">'mean'</span>,</span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">'loan_int_rate'</span>: <span class="st">'mean'</span>,</span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">'loan_percent_income'</span>:<span class="st">'mean'</span>,</span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">'int_percent_income'</span>:<span class="st">'mean'</span>})</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="1,2,3,4" data-code-annotation="1">Get mean of <code>loan_status</code>, <code>loan_int_rate</code>, <code>loan_percent_income</code>, and <code>int_percent_income</code> grouped by <code>loan_intent</code>.</span>
</dd>
</dl>
</div>
<div id="tbl-loan-intent" class="cell quarto-float anchored" data-execution_count="4">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-loan-intent-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Loan interest rate, loan percent of income, interest percent of income, and proportion of defaults by loan intent.
</figcaption>
<div aria-describedby="tbl-loan-intent-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_status</th>
<th data-quarto-table-cell-role="th">loan_int_rate</th>
<th data-quarto-table-cell-role="th">loan_percent_income</th>
<th data-quarto-table-cell-role="th">int_percent_income</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">loan_intent</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">DEBTCONSOLIDATION</td>
<td>0.282983</td>
<td>0.110173</td>
<td>0.170322</td>
<td>0.019230</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">EDUCATION</td>
<td>0.171012</td>
<td>0.109952</td>
<td>0.168219</td>
<td>0.018827</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">HOMEIMPROVEMENT</td>
<td>0.258327</td>
<td>0.111819</td>
<td>0.164516</td>
<td>0.018924</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">MEDICAL</td>
<td>0.264455</td>
<td>0.110711</td>
<td>0.172422</td>
<td>0.019511</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">PERSONAL</td>
<td>0.191385</td>
<td>0.110282</td>
<td>0.167568</td>
<td>0.018898</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">VENTURE</td>
<td>0.146221</td>
<td>0.109690</td>
<td>0.169147</td>
<td>0.018907</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>From the table, we can see that the loan interest rate, loan percent income, and interest percent income are fairly similar between all categories of loan intent. However, there is a remarkable difference in default rates. <code>DEBTCONSOLODATION</code>, <code>HOMEIMPROVEMENT</code>, and <code>MEDICAL</code> all have much higher default rates than the other three categories. This doesn’t align well with our findings from <a href="#fig-int-percent-income" class="quarto-xref">Figure&nbsp;1</a> since the default rates don’t align with <code>loan_int_rate</code>, <code>loan_percent_income</code>, and <code>int_percent_income</code>. As such, <code>loan_intent</code> may not be a good predictor.</p>
<p>Next, we will look at <code>person_home_ownership</code>.</p>
<div class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="annotated-cell-5"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1">1</button><span id="annotated-cell-5-1" class="code-annotation-target"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a>df_train.groupby([<span class="st">"person_home_ownership"</span>]).agg({<span class="st">'loan_status'</span>:<span class="st">'mean'</span>,</span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a>                                                 <span class="st">'loan_int_rate'</span>: <span class="st">'mean'</span>,</span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a>                                                 <span class="st">'loan_percent_income'</span>:<span class="st">'mean'</span>,</span>
<span id="annotated-cell-5-4"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a>                                                 <span class="st">'int_percent_income'</span>:<span class="st">'mean'</span>})</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="1,2,3,4" data-code-annotation="1">Get mean of <code>loan_status</code>, <code>loan_int_rate</code>, <code>loan_percent_income</code>, and <code>int_percent_income</code> grouped by <code>person_home_ownership</code>.</span>
</dd>
</dl>
</div>
<div id="tbl-home-ownership" class="cell quarto-float anchored" data-execution_count="5">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-home-ownership-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Loan interest rate, loan percent of income, interest percent of income, and proportion of defaults by home ownership status.
</figcaption>
<div aria-describedby="tbl-home-ownership-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_status</th>
<th data-quarto-table-cell-role="th">loan_int_rate</th>
<th data-quarto-table-cell-role="th">loan_percent_income</th>
<th data-quarto-table-cell-role="th">int_percent_income</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">person_home_ownership</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">MORTGAGE</td>
<td>0.124496</td>
<td>0.105270</td>
<td>0.151172</td>
<td>0.016350</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">OTHER</td>
<td>0.272727</td>
<td>0.120592</td>
<td>0.189870</td>
<td>0.024013</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">OWN</td>
<td>0.071429</td>
<td>0.109466</td>
<td>0.184076</td>
<td>0.020363</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">RENT</td>
<td>0.309761</td>
<td>0.114524</td>
<td>0.180943</td>
<td>0.021013</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>Unlike <code>loan_intent</code> (<a href="#tbl-loan-intent" class="quarto-xref">Table&nbsp;1</a>), <code>person_home_ownership</code> matches our findings from <a href="#fig-int-percent-income" class="quarto-xref">Figure&nbsp;1</a>. The default rates mostly lineup with <code>loan_int_rate</code>, <code>loan_percent_income</code>, and <code>int_percent_income</code> except for people who <code>OWN</code> a home, who have a relatively high <code>loan_percent_income</code> and <code>int_percent_income</code>, but have the lowest default rates. It is important to note however, that people who <code>OWN</code> a home have the second lowest <code>loan_int_rate</code>.</p>
<p>Additionally, as we can see below (<a href="#fig-home-intent" class="quarto-xref">Figure&nbsp;2</a>), <code>RENT</code> and <code>OTHER</code> have a relatively high amount of borrowers who are using the loans for <code>DEBTCONSOLIDATION</code> and <code>MEDICAL</code>. This matches up with the findings from <a href="#tbl-loan-intent" class="quarto-xref">Table&nbsp;1</a>. It seems that <code>person_home_ownership</code> is also a decent proxy for <code>loan_intent</code> while also matching the findings of <a href="#fig-int-percent-income" class="quarto-xref">Figure&nbsp;1</a>.</p>
<p>As such, we can expect <code>person_home_ownership</code> to possibly be a good predictor.</p>
<div id="cell-fig-home-intent" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="annotated-cell-6"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1">1</button><span id="annotated-cell-6-1" class="code-annotation-target"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a>home_intent <span class="op">=</span> ((df_train.groupby([<span class="st">'person_home_ownership'</span>, <span class="st">'loan_intent'</span>]).size()</span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a>                <span class="op">/</span> df_train.groupby([<span class="st">'person_home_ownership'</span>]).size())</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="2">2</button><span id="annotated-cell-6-3" class="code-annotation-target"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a>                .rename(<span class="st">'proportion'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="3">3</button><span id="annotated-cell-6-4" class="code-annotation-target"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a>                .reset_index())</span>
<span id="annotated-cell-6-5"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="4">4</button><span id="annotated-cell-6-6" class="code-annotation-target"><a href="#annotated-cell-6-6" aria-hidden="true" tabindex="-1"></a>home_intent_plt <span class="op">=</span> sns.barplot(home_intent,</span>
<span id="annotated-cell-6-7"><a href="#annotated-cell-6-7" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> <span class="st">'person_home_ownership'</span>,</span>
<span id="annotated-cell-6-8"><a href="#annotated-cell-6-8" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> <span class="st">'proportion'</span>,</span>
<span id="annotated-cell-6-9"><a href="#annotated-cell-6-9" aria-hidden="true" tabindex="-1"></a>            hue <span class="op">=</span> <span class="st">"loan_intent"</span>,</span>
<span id="annotated-cell-6-10"><a href="#annotated-cell-6-10" aria-hidden="true" tabindex="-1"></a>            palette <span class="op">=</span> pltt)</span>
<span id="annotated-cell-6-11"><a href="#annotated-cell-6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-12"><a href="#annotated-cell-6-12" aria-hidden="true" tabindex="-1"></a>home_intent_plt.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="st">"Home Ownership Status"</span>,</span>
<span id="annotated-cell-6-13"><a href="#annotated-cell-6-13" aria-hidden="true" tabindex="-1"></a>                   ylabel <span class="op">=</span> <span class="st">"Proportion"</span>, </span>
<span id="annotated-cell-6-14"><a href="#annotated-cell-6-14" aria-hidden="true" tabindex="-1"></a>                   title <span class="op">=</span> <span class="st">"Loan Intent by Home Ownership Status"</span>)</span>
<span id="annotated-cell-6-15"><a href="#annotated-cell-6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-16"><a href="#annotated-cell-6-16" aria-hidden="true" tabindex="-1"></a>home_intent_plt.legend(title <span class="op">=</span> <span class="st">"Loan Intent"</span>,</span>
<span id="annotated-cell-6-17"><a href="#annotated-cell-6-17" aria-hidden="true" tabindex="-1"></a>                       fontsize <span class="op">=</span> <span class="st">'8'</span>)<span class="op">;</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="1,2" data-code-annotation="1">Proportion of each <code>loan_intent</code> category for each <code>person_home_ownership</code> category.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="3" data-code-annotation="2">Renames (1) to <code>proportion</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="4" data-code-annotation="3">Resets index.</span>
</dd>
<dt data-target-cell="annotated-cell-6" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="6,7,8,9,10" data-code-annotation="4">Plots loan intent by home ownership status.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div id="fig-home-intent" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-home-intent-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="loans_files/figure-html/fig-home-intent-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-home-intent-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Loan intent by home ownership status.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Lastly, let’s look at how age relates to <code>loan_int_rate</code>, <code>loan_percent_income</code>, <code>int_percent_income</code>, and default rates. To do this, I created age ranges of 10 years (20’s, 30’s, 40’s, etc.).</p>
<div class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="annotated-cell-7"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-7-1"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="annotated-cell-7-2"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1">1</button><span id="annotated-cell-7-3" class="code-annotation-target"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a>age_labels <span class="op">=</span> [<span class="st">"20-29"</span>, <span class="st">"30-39"</span>, <span class="st">"40-49"</span>, <span class="st">"50-59"</span>, <span class="st">"60-69"</span>, <span class="st">"70-79"</span>, <span class="st">"80+"</span>]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="2">2</button><span id="annotated-cell-7-4" class="code-annotation-target"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a>age_bins <span class="op">=</span> np.concatenate((np.arange(<span class="dv">19</span>, <span class="dv">80</span>, <span class="dv">10</span>), [<span class="dv">150</span>]))</span>
<span id="annotated-cell-7-5"><a href="#annotated-cell-7-5" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="3">3</button><span id="annotated-cell-7-6" class="code-annotation-target"><a href="#annotated-cell-7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_age_groups(df):</span>
<span id="annotated-cell-7-7"><a href="#annotated-cell-7-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"age_group"</span>] <span class="op">=</span> pd.cut(x <span class="op">=</span> df[<span class="st">'person_age'</span>], bins <span class="op">=</span> age_bins, labels <span class="op">=</span> age_labels)</span>
<span id="annotated-cell-7-8"><a href="#annotated-cell-7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="annotated-cell-7-9"><a href="#annotated-cell-7-9" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="4">4</button><span id="annotated-cell-7-10" class="code-annotation-target"><a href="#annotated-cell-7-10" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> get_age_groups(df_train)</span>
<span id="annotated-cell-7-11"><a href="#annotated-cell-7-11" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="5">5</button><span id="annotated-cell-7-12" class="code-annotation-target"><a href="#annotated-cell-7-12" aria-hidden="true" tabindex="-1"></a>df_train.groupby([<span class="st">"age_group"</span>]).agg({<span class="st">'loan_status'</span>:<span class="st">'mean'</span>,</span>
<span id="annotated-cell-7-13"><a href="#annotated-cell-7-13" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">'loan_int_rate'</span>: <span class="st">'mean'</span>,</span>
<span id="annotated-cell-7-14"><a href="#annotated-cell-7-14" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">'loan_percent_income'</span>:<span class="st">'mean'</span>,</span>
<span id="annotated-cell-7-15"><a href="#annotated-cell-7-15" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">'int_percent_income'</span>:<span class="st">'mean'</span>})</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="3" data-code-annotation="1">List of age group labels.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="4" data-code-annotation="2">Set’s bins to [19, 29, 39, …, 79, 150].</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="6,7,8" data-code-annotation="3">Function that creates a new column called <code>age_group</code> and groups ages into 10 year intervals.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="10" data-code-annotation="4">Adds <code>age_group</code> to <code>df_train</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="12,13,14,15" data-code-annotation="5">Get mean of <code>loan_status</code>, <code>loan_int_rate</code>, <code>loan_percent_income</code>, and <code>int_percent_income</code> grouped by <code>age_group</code>.</span>
</dd>
</dl>
</div>
<div id="tbl-age-group" class="cell quarto-float anchored" data-execution_count="7">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-age-group-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Loan interest rate, loan percent of income, interest percent of income, and proportion of defaults by age group.
</figcaption>
<div aria-describedby="tbl-age-group-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_status</th>
<th data-quarto-table-cell-role="th">loan_int_rate</th>
<th data-quarto-table-cell-role="th">loan_percent_income</th>
<th data-quarto-table-cell-role="th">int_percent_income</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">age_group</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">20-29</td>
<td>0.220637</td>
<td>0.110169</td>
<td>0.171090</td>
<td>0.019270</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">30-39</td>
<td>0.200233</td>
<td>0.110843</td>
<td>0.164211</td>
<td>0.018574</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">40-49</td>
<td>0.193648</td>
<td>0.110663</td>
<td>0.160727</td>
<td>0.018248</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50-59</td>
<td>0.221622</td>
<td>0.111235</td>
<td>0.149243</td>
<td>0.016920</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">60-69</td>
<td>0.318182</td>
<td>0.109743</td>
<td>0.202955</td>
<td>0.022861</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">70-79</td>
<td>0.142857</td>
<td>0.107500</td>
<td>0.115714</td>
<td>0.011406</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">80+</td>
<td>0.000000</td>
<td>0.096100</td>
<td>0.110000</td>
<td>0.010571</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<div id="cell-fig-age-intent-home" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1">1</button><span id="annotated-cell-8-1" class="code-annotation-target"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a>age_intent <span class="op">=</span> ((df_train.groupby([<span class="st">'age_group'</span>, <span class="st">'loan_intent'</span>]).size()</span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a>               <span class="op">/</span> df_train.groupby([<span class="st">'age_group'</span>]).size())</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="2">2</button><span id="annotated-cell-8-3" class="code-annotation-target"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a>               .rename(<span class="st">'proportion'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="3">3</button><span id="annotated-cell-8-4" class="code-annotation-target"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a>               .reset_index())</span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="4">4</button><span id="annotated-cell-8-6" class="code-annotation-target"><a href="#annotated-cell-8-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">15</span>, <span class="dv">6</span>))</span>
<span id="annotated-cell-8-7"><a href="#annotated-cell-8-7" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="5">5</button><span id="annotated-cell-8-8" class="code-annotation-target"><a href="#annotated-cell-8-8" aria-hidden="true" tabindex="-1"></a>age_intent_plt <span class="op">=</span> sns.barplot(age_intent,</span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9" aria-hidden="true" tabindex="-1"></a>                             x <span class="op">=</span> <span class="st">'age_group'</span>,</span>
<span id="annotated-cell-8-10"><a href="#annotated-cell-8-10" aria-hidden="true" tabindex="-1"></a>                             y <span class="op">=</span> <span class="st">'proportion'</span>,</span>
<span id="annotated-cell-8-11"><a href="#annotated-cell-8-11" aria-hidden="true" tabindex="-1"></a>                             hue <span class="op">=</span> <span class="st">'loan_intent'</span>,</span>
<span id="annotated-cell-8-12"><a href="#annotated-cell-8-12" aria-hidden="true" tabindex="-1"></a>                             palette <span class="op">=</span> pltt,</span>
<span id="annotated-cell-8-13"><a href="#annotated-cell-8-13" aria-hidden="true" tabindex="-1"></a>                             ax <span class="op">=</span> ax[<span class="dv">0</span>])</span>
<span id="annotated-cell-8-14"><a href="#annotated-cell-8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-15"><a href="#annotated-cell-8-15" aria-hidden="true" tabindex="-1"></a>age_intent_plt.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="st">"Age Group"</span>,</span>
<span id="annotated-cell-8-16"><a href="#annotated-cell-8-16" aria-hidden="true" tabindex="-1"></a>                ylabel <span class="op">=</span> <span class="st">"Proportion"</span>, </span>
<span id="annotated-cell-8-17"><a href="#annotated-cell-8-17" aria-hidden="true" tabindex="-1"></a>                title <span class="op">=</span> <span class="st">"Loan Intent by Age Group"</span>)</span>
<span id="annotated-cell-8-18"><a href="#annotated-cell-8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-19"><a href="#annotated-cell-8-19" aria-hidden="true" tabindex="-1"></a>age_intent_plt.legend(title <span class="op">=</span> <span class="st">"Loan Intent"</span>)</span>
<span id="annotated-cell-8-20"><a href="#annotated-cell-8-20" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="6">6</button><span id="annotated-cell-8-21" class="code-annotation-target"><a href="#annotated-cell-8-21" aria-hidden="true" tabindex="-1"></a>age_home <span class="op">=</span> ((df_train.groupby([<span class="st">'age_group'</span>, <span class="st">'person_home_ownership'</span>]).size()</span>
<span id="annotated-cell-8-22"><a href="#annotated-cell-8-22" aria-hidden="true" tabindex="-1"></a>             <span class="op">/</span> df_train.groupby([<span class="st">'age_group'</span>]).size())</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="7">7</button><span id="annotated-cell-8-23" class="code-annotation-target"><a href="#annotated-cell-8-23" aria-hidden="true" tabindex="-1"></a>             .rename(<span class="st">'proportion'</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="8">8</button><span id="annotated-cell-8-24" class="code-annotation-target"><a href="#annotated-cell-8-24" aria-hidden="true" tabindex="-1"></a>             .reset_index())</span>
<span id="annotated-cell-8-25"><a href="#annotated-cell-8-25" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="9">9</button><span id="annotated-cell-8-26" class="code-annotation-target"><a href="#annotated-cell-8-26" aria-hidden="true" tabindex="-1"></a>age_home_plt <span class="op">=</span> sns.barplot(age_home,</span>
<span id="annotated-cell-8-27"><a href="#annotated-cell-8-27" aria-hidden="true" tabindex="-1"></a>                             x <span class="op">=</span> <span class="st">'age_group'</span>,</span>
<span id="annotated-cell-8-28"><a href="#annotated-cell-8-28" aria-hidden="true" tabindex="-1"></a>                             y <span class="op">=</span> <span class="st">'proportion'</span>,</span>
<span id="annotated-cell-8-29"><a href="#annotated-cell-8-29" aria-hidden="true" tabindex="-1"></a>                             hue <span class="op">=</span> <span class="st">'person_home_ownership'</span>,</span>
<span id="annotated-cell-8-30"><a href="#annotated-cell-8-30" aria-hidden="true" tabindex="-1"></a>                             palette <span class="op">=</span> pltt,</span>
<span id="annotated-cell-8-31"><a href="#annotated-cell-8-31" aria-hidden="true" tabindex="-1"></a>                             ax <span class="op">=</span> ax[<span class="dv">1</span>])</span>
<span id="annotated-cell-8-32"><a href="#annotated-cell-8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-33"><a href="#annotated-cell-8-33" aria-hidden="true" tabindex="-1"></a>age_home_plt.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="st">"Age Group"</span>,</span>
<span id="annotated-cell-8-34"><a href="#annotated-cell-8-34" aria-hidden="true" tabindex="-1"></a>                ylabel <span class="op">=</span> <span class="st">"Proportion"</span>, </span>
<span id="annotated-cell-8-35"><a href="#annotated-cell-8-35" aria-hidden="true" tabindex="-1"></a>                title <span class="op">=</span> <span class="st">"Home Ownership Status by Age Group"</span>)</span>
<span id="annotated-cell-8-36"><a href="#annotated-cell-8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-8-37"><a href="#annotated-cell-8-37" aria-hidden="true" tabindex="-1"></a>age_home_plt.legend(title <span class="op">=</span> <span class="st">"Home Ownership Status"</span>)<span class="op">;</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="1,2" data-code-annotation="1">Proportion of each <code>loan_intent</code> category for each <code>age_group</code> category.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="3" data-code-annotation="2">Renames (1) to <code>proportion</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="4" data-code-annotation="3">Resets index.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="6" data-code-annotation="4">Create 2 subplots.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="8,9,10,11,12,13" data-code-annotation="5">Plots loan intent by age group as first subplot.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="21,22" data-code-annotation="6">Proportion of each <code>person_home_ownership</code> category for each <code>age_group</code> category.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="23" data-code-annotation="7">Renames (6) to <code>proportion</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="24" data-code-annotation="8">Resets index.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="26,27,28,29,30,31" data-code-annotation="9">Plots home ownership status by age group as second subplot.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div id="fig-age-intent-home" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-age-intent-home-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="loans_files/figure-html/fig-age-intent-home-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-age-intent-home-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Loan intent and homeownership status by age group.
</figcaption>
</figure>
</div>
</div>
</div>
<p>From <a href="#tbl-age-group" class="quarto-xref">Table&nbsp;3</a>, we can see that <code>age_group</code> follows the trend found in <a href="#fig-int-percent-income" class="quarto-xref">Figure&nbsp;1</a> with the exception for 50-59 year olds who have a higher default rate despite having a relatively low <code>loan_percent_income</code> and <code>int_percent_income</code>. However, they do have the highest <code>loan_int_rate</code> out of all the age groups which may be a reason as to why their default rates are so high.</p>
<p>Then, comparing <code>age_group</code> with <code>loan_intent</code> (<a href="#fig-age-intent-home" class="quarto-xref">Figure&nbsp;3</a>), we can see that as borrowers get older, they spend more on <code>MEDICAL</code>. Yet despite spending the most on <code>MEDICAL</code>, 70-79 year olds have the lower default rates by far which contradicts our findings from <a href="#tbl-loan-intent" class="quarto-xref">Table&nbsp;1</a>. Additionally, there is no clear relationship between <code>age_group</code> and <code>person_home_ownership</code>.</p>
<p>Therefore, we can most likely conclude that <code>age_group</code> is not a good predictor.</p>
</section>
<section id="finding-a-threshold" class="level2">
<h2 class="anchored" data-anchor-id="finding-a-threshold">Finding a Threshold</h2>
<p>Using our findings, I will attempt to find an optimal threshold which will maximize expected profit from loans for the bank. I will do this by finding the best features through a semi-exhaustive search, then using those features, for logistic regression. I will then use the coefficients from the trained model as my weight vector, <code>w</code>, to compute the score, <code>s</code>, for each borrower (<a href="#eq-score" class="quarto-xref">Equation&nbsp;1</a>).</p>
<p>Lastly, I will test multiple thresholds to find the optimal threshold that maximizes expected profit per loan for the bank. The base profit to beat,assuming that the bank gives everyone loans, is $819.12.</p>
<div id="cell-24" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="annotated-cell-9"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="1">1</button><span id="annotated-cell-9-1" class="code-annotation-target"><a href="#annotated-cell-9-1" aria-hidden="true" tabindex="-1"></a>gain <span class="op">=</span> ((df_train[df_train[<span class="st">'loan_status'</span>] <span class="op">==</span> <span class="dv">0</span>][<span class="st">'loan_amnt'</span>]</span>
<span id="annotated-cell-9-2"><a href="#annotated-cell-9-2" aria-hidden="true" tabindex="-1"></a>         <span class="op">*</span>(<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">*</span>df_train[<span class="st">'loan_int_rate'</span>])<span class="op">**</span><span class="dv">10</span></span>
<span id="annotated-cell-9-3"><a href="#annotated-cell-9-3" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span> df_train[df_train[<span class="st">'loan_status'</span>] <span class="op">==</span> <span class="dv">0</span>][<span class="st">'loan_amnt'</span>])</span>
<span id="annotated-cell-9-4"><a href="#annotated-cell-9-4" aria-hidden="true" tabindex="-1"></a>         .<span class="bu">sum</span>())</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="2">2</button><span id="annotated-cell-9-5" class="code-annotation-target"><a href="#annotated-cell-9-5" aria-hidden="true" tabindex="-1"></a>cost <span class="op">=</span> ((df_train[df_train[<span class="st">'loan_status'</span>] <span class="op">==</span> <span class="dv">1</span>][<span class="st">'loan_amnt'</span>]</span>
<span id="annotated-cell-9-6"><a href="#annotated-cell-9-6" aria-hidden="true" tabindex="-1"></a>         <span class="op">*</span>(<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">*</span>df_train[<span class="st">'loan_int_rate'</span>])<span class="op">**</span><span class="dv">3</span></span>
<span id="annotated-cell-9-7"><a href="#annotated-cell-9-7" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span> <span class="fl">1.7</span><span class="op">*</span>df_train[df_train[<span class="st">'loan_status'</span>] <span class="op">==</span> <span class="dv">1</span>][<span class="st">'loan_amnt'</span>])</span>
<span id="annotated-cell-9-8"><a href="#annotated-cell-9-8" aria-hidden="true" tabindex="-1"></a>         .<span class="bu">sum</span>())</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="3">3</button><span id="annotated-cell-9-9" class="code-annotation-target"><a href="#annotated-cell-9-9" aria-hidden="true" tabindex="-1"></a>base_profit <span class="op">=</span> (gain<span class="op">+</span>cost)<span class="op">/</span>df_train.shape[<span class="dv">0</span>]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="4">4</button><span id="annotated-cell-9-10" class="code-annotation-target"><a href="#annotated-cell-9-10" aria-hidden="true" tabindex="-1"></a>base_profit</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-9" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="1,2,3,4" data-code-annotation="1">Calculates gain from giving out loans to everyone.</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="5,6,7,8" data-code-annotation="2">Calcultaes cost from giving out loans to everyone.</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="9" data-code-annotation="3">Calculates total base profit.</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="10" data-code-annotation="4">Outputs total base profit</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>819.1210295903265</code></pre>
</div>
</div>
<p>Before I start however, I need to prepare the data for training. I will drop our target variable <code>loan_status</code> and the bank’s “score” for each borrower, <code>loan_grade</code>, since I will generate my own scores for each borrower. We also drop <code>age_group</code> since we can simply use <code>person_age</code> instead, and one-hot encode all the qualitative columns.</p>
<div id="cell-27" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="annotated-cell-10"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1">1</button><span id="annotated-cell-10-1" class="code-annotation-target"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> df_train[<span class="st">'loan_status'</span>]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="2">2</button><span id="annotated-cell-10-2" class="code-annotation-target"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> df_train.drop([<span class="st">'loan_status'</span>, <span class="st">'loan_grade'</span>, <span class="st">'age_group'</span>], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="annotated-cell-10-3"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="3">3</button><span id="annotated-cell-10-4" class="code-annotation-target"><a href="#annotated-cell-10-4" aria-hidden="true" tabindex="-1"></a>qual_cols <span class="op">=</span> <span class="bu">list</span>(X_train.select_dtypes(exclude<span class="op">=</span>[<span class="st">'number'</span>]).columns)</span>
<span id="annotated-cell-10-5"><a href="#annotated-cell-10-5" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> pd.get_dummies(X_train,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="4">4</button><span id="annotated-cell-10-6" class="code-annotation-target"><a href="#annotated-cell-10-6" aria-hidden="true" tabindex="-1"></a>                          columns <span class="op">=</span> qual_cols)</span>
<span id="annotated-cell-10-7"><a href="#annotated-cell-10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-8"><a href="#annotated-cell-10-8" aria-hidden="true" tabindex="-1"></a>X_train.head()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="1" data-code-annotation="1">Set <code>loan_status</code> as my target variable <span class="math inline">\(y\)</span>.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="2" data-code-annotation="2">Drops <code>loan_status</code>, <code>loan_grade</code>, and <code>age_group</code> and set the resulting dataframe to be my features <span class="math inline">\(x\)</span>.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="4" data-code-annotation="3">Get all qualitative columns.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="6" data-code-annotation="4">One-hot encodes the qualitative columns.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">person_age</th>
<th data-quarto-table-cell-role="th">person_income</th>
<th data-quarto-table-cell-role="th">person_emp_length</th>
<th data-quarto-table-cell-role="th">loan_amnt</th>
<th data-quarto-table-cell-role="th">loan_int_rate</th>
<th data-quarto-table-cell-role="th">loan_percent_income</th>
<th data-quarto-table-cell-role="th">cb_person_cred_hist_length</th>
<th data-quarto-table-cell-role="th">int_percent_income</th>
<th data-quarto-table-cell-role="th">person_home_ownership_MORTGAGE</th>
<th data-quarto-table-cell-role="th">person_home_ownership_OTHER</th>
<th data-quarto-table-cell-role="th">person_home_ownership_OWN</th>
<th data-quarto-table-cell-role="th">person_home_ownership_RENT</th>
<th data-quarto-table-cell-role="th">loan_intent_DEBTCONSOLIDATION</th>
<th data-quarto-table-cell-role="th">loan_intent_EDUCATION</th>
<th data-quarto-table-cell-role="th">loan_intent_HOMEIMPROVEMENT</th>
<th data-quarto-table-cell-role="th">loan_intent_MEDICAL</th>
<th data-quarto-table-cell-role="th">loan_intent_PERSONAL</th>
<th data-quarto-table-cell-role="th">loan_intent_VENTURE</th>
<th data-quarto-table-cell-role="th">cb_person_default_on_file_N</th>
<th data-quarto-table-cell-role="th">cb_person_default_on_file_Y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>27</td>
<td>98000</td>
<td>3.0</td>
<td>11750</td>
<td>0.1347</td>
<td>0.12</td>
<td>6</td>
<td>0.016164</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>22</td>
<td>36996</td>
<td>5.0</td>
<td>10000</td>
<td>0.0751</td>
<td>0.27</td>
<td>4</td>
<td>0.020277</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>24</td>
<td>26000</td>
<td>2.0</td>
<td>1325</td>
<td>0.1287</td>
<td>0.05</td>
<td>4</td>
<td>0.006435</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>29</td>
<td>53004</td>
<td>2.0</td>
<td>15000</td>
<td>0.0963</td>
<td>0.28</td>
<td>10</td>
<td>0.026964</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>21</td>
<td>21700</td>
<td>2.0</td>
<td>5500</td>
<td>0.1491</td>
<td>0.25</td>
<td>2</td>
<td>0.037275</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
<td>False</td>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now that the data is ready to be trained, I will first use my findings from <code>@fig-int-percent-income</code> as a starting point. My initial features will be <code>loan_int_rate</code>, <code>loan_percent_income</code>, and <code>int_percent_income</code>.</p>
<div id="cell-30" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="annotated-cell-11"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-11-1"><a href="#annotated-cell-11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="annotated-cell-11-2"><a href="#annotated-cell-11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1">1</button><span id="annotated-cell-11-3" class="code-annotation-target"><a href="#annotated-cell-11-3" aria-hidden="true" tabindex="-1"></a>want_cols <span class="op">=</span> [<span class="st">'loan_int_rate'</span>, <span class="st">'loan_percent_income'</span>, <span class="st">'int_percent_income'</span>]</span>
<span id="annotated-cell-11-4"><a href="#annotated-cell-11-4" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="2">2</button><span id="annotated-cell-11-5" class="code-annotation-target"><a href="#annotated-cell-11-5" aria-hidden="true" tabindex="-1"></a>LR <span class="op">=</span> LogisticRegression()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="3">3</button><span id="annotated-cell-11-6" class="code-annotation-target"><a href="#annotated-cell-11-6" aria-hidden="true" tabindex="-1"></a>cross_val_score(LR, X_train[want_cols], y_train, cv <span class="op">=</span> <span class="dv">5</span>).mean()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="3" data-code-annotation="1">Sets a list <code>cols</code> with my intial column names.</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="5" data-code-annotation="2">Initialize logistic regression instance.</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="6" data-code-annotation="3">Outputs the mean of cross-validation using five folds.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>0.8256407088706057</code></pre>
</div>
</div>
<p>A score of <span class="math inline">\(\approx .83\)</span> is a good start. Now I will try to find other features that may improve the score. I do this by making a power set from the rest of the columns and testing each with <code>loan_int_rate</code>, <code>loan_percent_income</code>, and <code>int_percent_income</code> using five-fold cross validation.</p>
<div id="cell-33" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="annotated-cell-12"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-12-1"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> chain, combinations</span>
<span id="annotated-cell-12-2"><a href="#annotated-cell-12-2" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="1">1</button><span id="annotated-cell-12-3" class="code-annotation-target"><a href="#annotated-cell-12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> power_set(iterable):</span>
<span id="annotated-cell-12-4"><a href="#annotated-cell-12-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''power_set([1,2,3]) --&gt; () (1,) (2,) (3,) (1,2) (1,3) (2,3) (1,2,3)'''</span></span>
<span id="annotated-cell-12-5"><a href="#annotated-cell-12-5" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">list</span>(iterable)</span>
<span id="annotated-cell-12-6"><a href="#annotated-cell-12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> chain.from_iterable(combinations(s, r) <span class="cf">for</span> r <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(s)<span class="op">+</span><span class="dv">1</span>))</span>
<span id="annotated-cell-12-7"><a href="#annotated-cell-12-7" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="2">2</button><span id="annotated-cell-12-8" class="code-annotation-target"><a href="#annotated-cell-12-8" aria-hidden="true" tabindex="-1"></a>all_qual_cols <span class="op">=</span> (<span class="bu">list</span>({col.rsplit(<span class="st">'_'</span>, <span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="annotated-cell-12-9"><a href="#annotated-cell-12-9" aria-hidden="true" tabindex="-1"></a>                       <span class="cf">for</span> col <span class="kw">in</span> X_train.select_dtypes(exclude<span class="op">=</span>[<span class="st">'number'</span>]).columns}))</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="3">3</button><span id="annotated-cell-12-10" class="code-annotation-target"><a href="#annotated-cell-12-10" aria-hidden="true" tabindex="-1"></a>all_quant_cols <span class="op">=</span> <span class="bu">list</span>(X_train.select_dtypes(exclude<span class="op">=</span>[<span class="st">"bool_"</span>,<span class="st">"object_"</span>]).columns)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="4">4</button><span id="annotated-cell-12-11" class="code-annotation-target"><a href="#annotated-cell-12-11" aria-hidden="true" tabindex="-1"></a>excess_cols <span class="op">=</span> all_qual_cols <span class="op">+</span> all_quant_cols[<span class="dv">0</span>:<span class="dv">4</span>] <span class="op">+</span> all_quant_cols[<span class="dv">6</span>:<span class="dv">8</span>]</span>
<span id="annotated-cell-12-12"><a href="#annotated-cell-12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-13"><a href="#annotated-cell-12-13" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="5">5</button><span id="annotated-cell-12-14" class="code-annotation-target"><a href="#annotated-cell-12-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> power_set_cols(df, cols):</span>
<span id="annotated-cell-12-15"><a href="#annotated-cell-12-15" aria-hidden="true" tabindex="-1"></a>    power_cols <span class="op">=</span> <span class="bu">list</span>(<span class="bu">list</span>(s) <span class="cf">for</span> s <span class="kw">in</span> power_set(cols))[<span class="dv">1</span>:]</span>
<span id="annotated-cell-12-16"><a href="#annotated-cell-12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-17"><a href="#annotated-cell-12-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(power_cols)):</span>
<span id="annotated-cell-12-18"><a href="#annotated-cell-12-18" aria-hidden="true" tabindex="-1"></a>        all_cols <span class="op">=</span> []</span>
<span id="annotated-cell-12-19"><a href="#annotated-cell-12-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> power_cols[i]:</span>
<span id="annotated-cell-12-20"><a href="#annotated-cell-12-20" aria-hidden="true" tabindex="-1"></a>            all_cols <span class="op">=</span> all_cols <span class="op">+</span> [x_col <span class="cf">for</span> x_col <span class="kw">in</span> df.columns <span class="cf">if</span> col <span class="kw">in</span> x_col]</span>
<span id="annotated-cell-12-21"><a href="#annotated-cell-12-21" aria-hidden="true" tabindex="-1"></a>            power_cols[i] <span class="op">=</span> all_cols</span>
<span id="annotated-cell-12-22"><a href="#annotated-cell-12-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> power_cols</span>
<span id="annotated-cell-12-23"><a href="#annotated-cell-12-23" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="6">6</button><span id="annotated-cell-12-24" class="code-annotation-target"><a href="#annotated-cell-12-24" aria-hidden="true" tabindex="-1"></a>power_cols <span class="op">=</span> [<span class="bu">list</span>(p) <span class="cf">for</span> p <span class="kw">in</span> power_set_cols(X_train, excess_cols)]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="7">7</button><span id="annotated-cell-12-25" class="code-annotation-target"><a href="#annotated-cell-12-25" aria-hidden="true" tabindex="-1"></a>all_cols <span class="op">=</span> [want_cols] <span class="op">+</span> [want_cols <span class="op">+</span> p <span class="cf">for</span> p <span class="kw">in</span> power_cols]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="3,4,5,6" data-code-annotation="1">Function for creating a power set of a list.</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="8,9" data-code-annotation="2">Gets all qualitative columns without one-hot encoded suffixes (ex. <code>person_home_ownership_MORTGAGE</code> <span class="math inline">\(\to\)</span> <code>person_home_ownership</code>)</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="10" data-code-annotation="3">Gets all quantitative columns.</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="11" data-code-annotation="4">Combines (2) and (3) together.</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="14,15,17,18,19,20,21,22" data-code-annotation="5">Function that creates a power set of (4) then adds all one-hot encoding suffixes back for each set in power set (ex. <code>person_home_owndership_MORTGAGE</code>, <code>person_home_ownership_RENT</code>, etc. for <code>person_home_ownership</code>).</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="24" data-code-annotation="6">Converts all sets in power set to lists.</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="25" data-code-annotation="7">Prepends <code>want_cols</code> to front of every list in power set.</span>
</dd>
</dl>
</div>
</div>
<p>Here’s what one such combination looks like.</p>
<div id="cell-36" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>all_cols[<span class="dv">123</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>['loan_int_rate',
 'loan_percent_income',
 'int_percent_income',
 'person_income',
 'loan_amnt',
 'cb_person_cred_hist_length']</code></pre>
</div>
</div>
<p>Using the list of column combinations, I compare the mean of the cross-validation scores for each one and store the columns that have the best score.</p>
<div id="cell-38" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="annotated-cell-14"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="1">1</button><span id="annotated-cell-14-1" class="code-annotation-target"><a href="#annotated-cell-14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cross_val(model, cv):</span>
<span id="annotated-cell-14-2"><a href="#annotated-cell-14-2" aria-hidden="true" tabindex="-1"></a>  best_score <span class="op">=</span> ([], <span class="dv">0</span>)</span>
<span id="annotated-cell-14-3"><a href="#annotated-cell-14-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> col <span class="kw">in</span> all_cols:</span>
<span id="annotated-cell-14-4"><a href="#annotated-cell-14-4" aria-hidden="true" tabindex="-1"></a>    cv_scores <span class="op">=</span> cross_val_score(model, X_train[col], y_train, cv <span class="op">=</span> cv)</span>
<span id="annotated-cell-14-5"><a href="#annotated-cell-14-5" aria-hidden="true" tabindex="-1"></a>    col_scores <span class="op">=</span> (col, cv_scores.mean())</span>
<span id="annotated-cell-14-6"><a href="#annotated-cell-14-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col_scores[<span class="dv">1</span>] <span class="op">&gt;</span> best_score[<span class="dv">1</span>]:</span>
<span id="annotated-cell-14-7"><a href="#annotated-cell-14-7" aria-hidden="true" tabindex="-1"></a>      best_score <span class="op">=</span> col_scores</span>
<span id="annotated-cell-14-8"><a href="#annotated-cell-14-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> best_score</span>
<span id="annotated-cell-14-9"><a href="#annotated-cell-14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-10"><a href="#annotated-cell-14-10" aria-hidden="true" tabindex="-1"></a>best_score <span class="op">=</span> cross_val(LR, <span class="dv">5</span>)</span>
<span id="annotated-cell-14-11"><a href="#annotated-cell-14-11" aria-hidden="true" tabindex="-1"></a>best_score</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-14" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="1,2,3,4,5,6,7,8" data-code-annotation="1">Uses cross-validation to find the best scores and returns ([best columns], best score).</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>(['loan_int_rate',
  'loan_percent_income',
  'int_percent_income',
  'person_home_ownership_MORTGAGE',
  'person_home_ownership_OTHER',
  'person_home_ownership_OWN',
  'person_home_ownership_RENT'],
 0.8474301677042732)</code></pre>
</div>
</div>
<p>We can see that the best columns confirm the findings from exploring the data. With these columns, I can now train my model using logistic regression.</p>
<div id="cell-41" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> best_score[<span class="dv">0</span>]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>LR.fit(X_train[cols], y_train)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>score <span class="op">=</span> LR.score(X_train[cols], y_train)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>0.8469499148508799</code></pre>
</div>
</div>
<p>Below are the coefficients which I will use as the weights for my score function.</p>
<div id="cell-43" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> LR.coef_[<span class="dv">0</span>]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>w</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>array([20.43778674,  8.01023218,  2.22540065, -0.0730397 ,  0.36076484,
       -1.18065954,  0.8942643 ])</code></pre>
</div>
</div>
<p>My score(<a href="#eq-score" class="quarto-xref">Equation&nbsp;1</a>) function:</p>
<div id="cell-45" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> linear_score(X, w):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X<span class="op">@</span>w</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With my score function, I can now give each borrower a score and test various thresholds by profit per loan (<a href="#fig-thresh-profit" class="quarto-xref">Figure&nbsp;4</a>).</p>
<div id="cell-fig-thresh-profit" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="annotated-cell-18"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-18-1"><a href="#annotated-cell-18-1" aria-hidden="true" tabindex="-1"></a>num_thresholds <span class="op">=</span> <span class="dv">101</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="1">1</button><span id="annotated-cell-18-2" class="code-annotation-target"><a href="#annotated-cell-18-2" aria-hidden="true" tabindex="-1"></a>profit <span class="op">=</span> np.zeros(num_thresholds)</span>
<span id="annotated-cell-18-3"><a href="#annotated-cell-18-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="2">2</button><span id="annotated-cell-18-4" class="code-annotation-target"><a href="#annotated-cell-18-4" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> linear_score(X_train[cols], w)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="3">3</button><span id="annotated-cell-18-5" class="code-annotation-target"><a href="#annotated-cell-18-5" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> np.linspace(s.<span class="bu">min</span>()<span class="op">-</span><span class="fl">0.1</span>, s.<span class="bu">max</span>()<span class="op">+</span><span class="fl">0.1</span>, num_thresholds)</span>
<span id="annotated-cell-18-6"><a href="#annotated-cell-18-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_thresholds):</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="4">4</button><span id="annotated-cell-18-7" class="code-annotation-target"><a href="#annotated-cell-18-7" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> s <span class="op">&gt;=</span> T[i]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="5">5</button><span id="annotated-cell-18-8" class="code-annotation-target"><a href="#annotated-cell-18-8" aria-hidden="true" tabindex="-1"></a>    TN <span class="op">=</span> X_train[((y_pred <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (y_train <span class="op">==</span> <span class="dv">0</span>))]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="6">6</button><span id="annotated-cell-18-9" class="code-annotation-target"><a href="#annotated-cell-18-9" aria-hidden="true" tabindex="-1"></a>    FN <span class="op">=</span> X_train[((y_pred <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (y_train <span class="op">==</span> <span class="dv">1</span>))]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="7">7</button><span id="annotated-cell-18-10" class="code-annotation-target"><a href="#annotated-cell-18-10" aria-hidden="true" tabindex="-1"></a>    gain <span class="op">=</span> (TN[<span class="st">'loan_amnt'</span>]<span class="op">*</span>(<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">*</span>TN[<span class="st">'loan_int_rate'</span>])<span class="op">**</span><span class="dv">10</span> <span class="op">-</span> TN[<span class="st">'loan_amnt'</span>]).<span class="bu">sum</span>()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="8">8</button><span id="annotated-cell-18-11" class="code-annotation-target"><a href="#annotated-cell-18-11" aria-hidden="true" tabindex="-1"></a>    cost <span class="op">=</span> (FN[<span class="st">'loan_amnt'</span>]<span class="op">*</span>(<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">*</span>FN[<span class="st">'loan_int_rate'</span>])<span class="op">**</span><span class="dv">3</span> <span class="op">-</span> <span class="fl">1.7</span><span class="op">*</span>FN[<span class="st">'loan_amnt'</span>]).<span class="bu">sum</span>()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="9">9</button><span id="annotated-cell-18-12" class="code-annotation-target"><a href="#annotated-cell-18-12" aria-hidden="true" tabindex="-1"></a>    total_loans <span class="op">=</span> TN.shape[<span class="dv">0</span>] <span class="op">+</span> FN.shape[<span class="dv">0</span>]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="10">10</button><span id="annotated-cell-18-13" class="code-annotation-target"><a href="#annotated-cell-18-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> total_loans <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="annotated-cell-18-14"><a href="#annotated-cell-18-14" aria-hidden="true" tabindex="-1"></a>        profit[i] <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-18-15"><a href="#annotated-cell-18-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="annotated-cell-18-16"><a href="#annotated-cell-18-16" aria-hidden="true" tabindex="-1"></a>        profit[i] <span class="op">=</span> (gain <span class="op">+</span> cost) <span class="op">/</span> total_loans</span>
<span id="annotated-cell-18-17"><a href="#annotated-cell-18-17" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="11">11</button><span id="annotated-cell-18-18" class="code-annotation-target"><a href="#annotated-cell-18-18" aria-hidden="true" tabindex="-1"></a>profit_plt <span class="op">=</span> sns.lineplot(x <span class="op">=</span> T, y <span class="op">=</span> profit)</span>
<span id="annotated-cell-18-19"><a href="#annotated-cell-18-19" aria-hidden="true" tabindex="-1"></a>profit_plt.grid()</span>
<span id="annotated-cell-18-20"><a href="#annotated-cell-18-20" aria-hidden="true" tabindex="-1"></a>profit_plt.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="vs">r"Threshold $t$"</span>, ylabel <span class="op">=</span> <span class="st">"Expected Profit Per Loan"</span>)<span class="op">;</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-18" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="2" data-code-annotation="1">Initialize profit vector with 0s.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="4" data-code-annotation="2">Vector of scores for each borrower.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="5" data-code-annotation="3">Vector of 100 thresholds to test from <span class="math inline">\([\max(s)-1, \max(s)+1]\)</span>.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="7" data-code-annotation="4">Vector of predictions for score <span class="math inline">\(\geq\)</span> threshold (defaults).</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="8" data-code-annotation="5">True negatives.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="9" data-code-annotation="6">False negatives.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="10" data-code-annotation="7">See <a href="#eq-profit-cost" class="quarto-xref">Equation&nbsp;2</a>.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="11" data-code-annotation="8">See <a href="#eq-profit-cost" class="quarto-xref">Equation&nbsp;2</a>.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="12" data-code-annotation="9">Total number of loans. (Cost is negative.)</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="13" data-code-annotation="10">Sets profit[i] to 0 if no loans are made, otherwise to expected profit per loan.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="18" data-code-annotation="11">Plots expected profit per loan for every threshold <span class="math inline">\(t\)</span>.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div id="fig-thresh-profit" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-thresh-profit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="loans_files/figure-html/fig-thresh-profit-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-thresh-profit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Expected profit per loan for threshold <span class="math inline">\(t\)</span>.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-49" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>max_profit_index <span class="op">=</span> np.argmax(profit)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>profit</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> T[max_profit_index]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="bu">max</span>(profit)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>t, p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>(4.721345771117955, 1757.8292670626274)</code></pre>
</div>
</div>
<p>It looks like the best threshold is approximately <code>4.72</code> and the max expected profit per loan is approximately <code>$1757.83</code>. With weights, <code>w</code>, and threshold <code>t</code>, I am now ready to test the model.</p>
</section>
<section id="evaluating-the-model-from-the-banks-perspective" class="level2">
<h2 class="anchored" data-anchor-id="evaluating-the-model-from-the-banks-perspective">Evaluating the Model from the Bank’s Perspective</h2>
<p>First, we need to prepare our testing data. I use the same method as my training data.</p>
<div id="cell-53" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/PhilChodrow/ml-notes/main/data/credit-risk/test.csv"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> prepare_data(df_test)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> df_test[<span class="st">'loan_status'</span>]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> df_test.drop([<span class="st">'loan_status'</span>, <span class="st">'loan_grade'</span>], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> pd.get_dummies(df_test,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                        columns <span class="op">=</span> qual_cols)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I use my weight vector, <code>w</code>, and my threshold <code>t</code> to compute the expected profit per loan for the bank using the testing data.</p>
<div id="cell-55" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>num_thresholds <span class="op">=</span> <span class="dv">101</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> linear_score(X_test[cols], w)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># t = 4.721345771117955</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> s <span class="op">&gt;=</span> t</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>TN <span class="op">=</span> X_test[((y_pred <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (y_test <span class="op">==</span> <span class="dv">0</span>))]</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>FN <span class="op">=</span> X_test[((y_pred <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (y_test <span class="op">==</span> <span class="dv">1</span>))]</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>gain <span class="op">=</span> (TN[<span class="st">'loan_amnt'</span>]<span class="op">*</span>(<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">*</span>TN[<span class="st">'loan_int_rate'</span>])<span class="op">**</span><span class="dv">10</span> <span class="op">-</span> TN[<span class="st">'loan_amnt'</span>]).<span class="bu">sum</span>()</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>cost <span class="op">=</span> (FN[<span class="st">'loan_amnt'</span>]<span class="op">*</span>(<span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span><span class="op">*</span>FN[<span class="st">'loan_int_rate'</span>])<span class="op">**</span><span class="dv">3</span> <span class="op">-</span> <span class="fl">1.7</span><span class="op">*</span>FN[<span class="st">'loan_amnt'</span>]).<span class="bu">sum</span>()</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>total_loans <span class="op">=</span> TN.shape[<span class="dv">0</span>]<span class="op">+</span>FN.shape[<span class="dv">0</span>]</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>profit <span class="op">=</span> (gain <span class="op">+</span> cost) <span class="op">/</span> total_loans</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>profit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>1714.514369055408</code></pre>
</div>
</div>
<p>Using my model, the bank can expect to make about <code>$1714.51</code> per loan, slightly less than the training set.</p>
</section>
<section id="evaluating-the-model-from-the-borrowers-perspective" class="level2">
<h2 class="anchored" data-anchor-id="evaluating-the-model-from-the-borrowers-perspective">Evaluating the Model from the Borrower’s Perspective</h2>
<p>An important aspect of good machine learning models is fairness and minimal bias. I will be exploring the impact of my autonomous decision-making system on different segments of the population of borrowers by <code>age_group</code>, <code>loan_intent</code>, and <code>income_level</code>.</p>
<section id="loans-by-age" class="level3">
<h3 class="anchored" data-anchor-id="loans-by-age">Loans by Age</h3>
<div id="cell-fig-loans-age" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>age_labels <span class="op">=</span> [<span class="st">"20-29"</span>, <span class="st">"30-39"</span>, <span class="st">"40-49"</span>, <span class="st">"50-59"</span>, <span class="st">"60-69"</span>, <span class="st">"70-79"</span>]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>age_bins <span class="op">=</span> np.concatenate((np.arange(<span class="dv">19</span>, <span class="dv">70</span>, <span class="dv">10</span>), [<span class="dv">150</span>]))</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> get_age_groups(df_test)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>df_test[<span class="st">'y_pred'</span>] <span class="op">=</span> y_pred</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>age_loans <span class="op">=</span> (<span class="dv">1</span><span class="op">-</span>(df_test.groupby([<span class="st">'age_group'</span>,<span class="st">'y_pred'</span>]).size() <span class="op">/</span> df_test.groupby([<span class="st">'age_group'</span>]).size())).rename(<span class="st">'proportion'</span>).reset_index()</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>age_loans[<span class="st">'y_pred'</span>] <span class="op">=</span> age_loans[<span class="st">'y_pred'</span>].astype(<span class="st">'string'</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>age_loans_plt <span class="op">=</span> sns.barplot(age_loans,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> <span class="st">'age_group'</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> <span class="st">'proportion'</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>            hue <span class="op">=</span> <span class="st">'y_pred'</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>            palette <span class="op">=</span> pltt)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>age_loans_plt.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="st">'Age Group'</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                  ylabel <span class="op">=</span> <span class="st">'Proportion'</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>                  title <span class="op">=</span> <span class="st">'Expected Loans by Age Group'</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>age_loans_plt.legend(title <span class="op">=</span> <span class="st">'Loans'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-loans-age" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-loans-age-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="loans_files/figure-html/fig-loans-age-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-loans-age-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Expected loans by age group.
</figcaption>
</figure>
</div>
</div>
</div>
<p>From <a href="#fig-loans-age" class="quarto-xref">Figure&nbsp;5</a>, we can see that people older than 60 will have a much harder time getting a loan with only about 40% being approved of taking a loan.</p>
</section>
<section id="loan-intent" class="level3">
<h3 class="anchored" data-anchor-id="loan-intent">Loan Intent</h3>
<div class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>intent_loans <span class="op">=</span> (<span class="dv">1</span><span class="op">-</span>df_test.groupby([<span class="st">'loan_intent'</span>]).agg({<span class="st">'loan_status'</span>:<span class="st">'mean'</span>, <span class="st">'y_pred'</span>:<span class="st">'mean'</span>})).reset_index().rename({<span class="st">'loan_status'</span>:<span class="st">'actual'</span>, <span class="st">'y_pred'</span>:<span class="st">'predicted'</span>}, axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>intent_loans[<span class="st">'difference'</span>] <span class="op">=</span> intent_loans[<span class="st">'predicted'</span>] <span class="op">-</span> intent_loans[<span class="st">'actual'</span>]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>intent_loans</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-intent-diff" class="cell quarto-float anchored" data-execution_count="23">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-intent-diff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;4: Difference in actual and predicted loan rates by loan intent.
</figcaption>
<div aria-describedby="tbl-intent-diff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">loan_intent</th>
<th data-quarto-table-cell-role="th">actual</th>
<th data-quarto-table-cell-role="th">predicted</th>
<th data-quarto-table-cell-role="th">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>DEBTCONSOLIDATION</td>
<td>0.712389</td>
<td>0.676991</td>
<td>-0.035398</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>EDUCATION</td>
<td>0.832483</td>
<td>0.693878</td>
<td>-0.138605</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>HOMEIMPROVEMENT</td>
<td>0.750000</td>
<td>0.756494</td>
<td>0.006494</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>MEDICAL</td>
<td>0.715750</td>
<td>0.672880</td>
<td>-0.042870</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>PERSONAL</td>
<td>0.779559</td>
<td>0.688377</td>
<td>-0.091182</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>VENTURE</td>
<td>0.853734</td>
<td>0.716805</td>
<td>-0.136929</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>From <a href="#tbl-intent-diff" class="quarto-xref">Table&nbsp;4</a>, we can see <code>HOMEIMPROVEMENT</code> was the only <code>loan_intent</code> to receive an increase in loans. All other intents received fewer loans from my model. The two biggest decreases in loans were for <code>EDUCATION</code> and <code>VENTURE</code>.</p>
<p>An important thing to note is the relatively small decrease in loans for <code>MEDICAL</code> despite the relatively large amount of defaults (<a href="#tbl-loan-intent" class="quarto-xref">Table&nbsp;1</a>). This is important because it would be unfair if those seeking medical attention could not recieve loans. I use unfair in the sense that bias against certain circumstances that are out of ones control is unfair. In the case of medical care, many illnesses or injuries are “random” and not entirely in ones control. Sometimes, unfortunate things and mistakes just happen. To be biased against those unable to pay for medical care themselves is unfair. For example, if a person develops cancer, is it fair if they are denied a loan simply because they have cancer and are more likely to default? No it is not. Everyone deserves a chance for medical care and banks should support the people in need of a loan for medical care with lower interest rates which could in turn lower default rates. As such, my model does a good job of being relatively unbiased towards <code>MEDICAL</code> loans.</p>
</section>
<section id="income-levels" class="level3">
<h3 class="anchored" data-anchor-id="income-levels">Income Levels</h3>
<div id="cell-fig-income-loans" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>income_bins <span class="op">=</span> np.concatenate((np.arange(<span class="op">-</span><span class="dv">1</span>, <span class="dv">100000</span>, <span class="dv">10000</span>), [<span class="dv">2000000</span>]))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>income_labels <span class="op">=</span> []</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(income_bins)<span class="op">-</span><span class="dv">2</span>):</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    income_labels <span class="op">=</span> income_labels <span class="op">+</span> [<span class="ss">f'</span><span class="sc">{</span>income_bins[i]<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>income_bins[i<span class="op">+</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>]</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>income_labels <span class="op">=</span> income_labels <span class="op">+</span> [<span class="st">'100000+'</span>]</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_income_class(df):</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    df_ <span class="op">=</span> df.copy()</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    df_[<span class="st">"income_level"</span>] <span class="op">=</span> pd.cut(x <span class="op">=</span> df_[<span class="st">'person_income'</span>], bins <span class="op">=</span> income_bins, labels <span class="op">=</span> income_labels)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> get_income_class(df_test)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>income_level_loans <span class="op">=</span> <span class="dv">1</span><span class="op">-</span>(df_test.groupby([<span class="st">'income_level'</span>])[<span class="st">'y_pred'</span>].<span class="bu">sum</span>() <span class="op">/</span> df_test.groupby([<span class="st">'income_level'</span>]).size())</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>loan_income_plt <span class="op">=</span> sns.lineplot(income_level_loans)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>loan_income_plt.set_xticklabels(loan_income_plt.get_xticklabels(), rotation<span class="op">=</span><span class="dv">40</span>, ha<span class="op">=</span><span class="st">"right"</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>loan_income_plt.<span class="bu">set</span>(xlabel <span class="op">=</span> <span class="st">'Income'</span>,</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>                    ylabel <span class="op">=</span> <span class="st">'Proportion'</span>,</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>                    title <span class="op">=</span> <span class="st">'Proportion Given Loans by Income'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-income-loans" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-income-loans-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="loans_files/figure-html/fig-income-loans-output-1.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-income-loans-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Expected loans by income level.
</figcaption>
</figure>
</div>
</div>
</div>
<p>From <a href="#fig-income-loans" class="quarto-xref">Figure&nbsp;6</a>, we can see that as income level increases, more prospective borrowers are approved for loans. This makes sense, since higher income individuals are more likely to pay back loans. However, it is a bit worrying that lower income individuals will have a hard time getting loans, since they may be the ones that need it the most.</p>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this study, I built an automated decision-making system for loans. I optimized the predicted expected profit per loan for the bank by giving each prospective borrower a score(<a href="#eq-score" class="quarto-xref">Equation&nbsp;1</a>) and then choosing a threshold to determine the borrowers that would receive a loan. Afterwards, I analyzed my model for biases by age group, loan intents, and income level.</p>
<p>By using the features <code>loan_int_rate</code>, <code>loan_percent_income</code>, <code>int_percent_income</code>, and <code>person_home_ownership</code>, the model produced an expected ouput of about $1714.51. This surpasses the base profit by about $895.39, an approximately 209% increase in profit.</p>
<p>Furthermore, analysis of my model showed that it approves fewer loans to prospective borrowers over the age of 60, borrowers who intend to take a loan for education and venture, and borrowers with lower income. I also specifically analyzed the impact my model had on borrowers who are intending to take a loan out for medical reasons and found that there was a slight, but not a significant drop in loans approved. Lastly, I discussed why my model would’ve been unfair for borrowers looking to receive a medical loan if my model had a bias against them.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>